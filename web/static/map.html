<!DOCTYPE html>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vega/5.9.0/vega.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <div id="nyc-taxi-vs-citi-select-container" style="">
        <div>
            <h2 class="input-header"> Weekday time window </h2>
            <div class="radio-container">
                <input id="nyc-taxi-vs-citi-time-1" type="radio" name="nyc-taxi-vs-citi-time" value="8:00 AM–11:00 AM" checked="">
                <label for="nyc-taxi-vs-citi-time-1">8:00 AM–11:00 AM</label>
            </div>

            <div class="radio-container">
                <input id="nyc-taxi-vs-citi-time-2" type="radio" name="nyc-taxi-vs-citi-time" value="11:00 AM–4:00 PM">
                <label for="nyc-taxi-vs-citi-time-2">11:00 AM–4:00 PM</label>
            </div>

            <div class="radio-container">
                <input id="nyc-taxi-vs-citi-time-3" type="radio" name="nyc-taxi-vs-citi-time" value="4:00 PM–7:00 PM">
                <label for="nyc-taxi-vs-citi-time-3">4:00 PM–7:00 PM</label>
            </div>

            <div class="radio-container">
                <input id="nyc-taxi-vs-citi-time-4" type="radio" name="nyc-taxi-vs-citi-time" value="7:00 PM–10:00 PM">
                <label for="nyc-taxi-vs-citi-time-4">7:00 PM–10:00 PM</label>
            </div>

            <div class="radio-container">
                <input id="nyc-taxi-vs-citi-time-5" type="radio" name="nyc-taxi-vs-citi-time" value="10:00 PM–8:00 AM">
                <label for="nyc-taxi-vs-citi-time-5">10:00 PM–8:00 AM</label>
            </div>
        </div>
    </div>

    <h2 class="taxi-vs-citi-map-title">From Flatiron, weekdays 8:00 AM–11:00 AM</h2>

    <div class="nyc-taxi-zones-map-wrapper">
        <div id="nyc-taxi-zones-map" style="display: block;margin: auto;"><canvas width="900" height="1280" class="marks" style="width: 450px; height: 640px;"></canvas><div class="vega-bindings"><div class="vega-bind"><span class="vega-bind-name">selected_location</span><select name="selected_location"><option value="Alphabet City">Alphabet City</option><option value="Battery Park">Battery Park</option><option value="Battery Park City">Battery Park City</option><option value="Bedford">Bedford</option><option value="Bloomingdale">Bloomingdale</option><option value="Boerum Hill">Boerum Hill</option><option value="Brooklyn Heights">Brooklyn Heights</option><option value="Brooklyn Navy Yard">Brooklyn Navy Yard</option><option value="Bushwick South">Bushwick South</option><option value="Carroll Gardens">Carroll Gardens</option><option value="Central Park">Central Park</option><option value="Chinatown">Chinatown</option><option value="Clinton East">Clinton East</option><option value="Clinton Hill">Clinton Hill</option><option value="Clinton West">Clinton West</option><option value="Cobble Hill">Cobble Hill</option><option value="Columbia Street">Columbia Street</option><option value="Crown Heights North">Crown Heights North</option><option value="Downtown Brooklyn/MetroTech">Downtown Brooklyn/MetroTech</option><option value="DUMBO/Vinegar Hill">DUMBO/Vinegar Hill</option><option value="East Chelsea">East Chelsea</option><option value="East Harlem South">East Harlem South</option><option value="East Village">East Village</option><option value="East Williamsburg">East Williamsburg</option><option value="Financial District North">Financial District North</option><option value="Financial District South">Financial District South</option><option value="Flatiron">Flatiron</option><option value="Fort Greene">Fort Greene</option><option value="Garment District">Garment District</option><option value="Gowanus">Gowanus</option><option value="Gramercy">Gramercy</option><option value="Greenpoint">Greenpoint</option><option value="Greenwich Village North">Greenwich Village North</option><option value="Greenwich Village South">Greenwich Village South</option><option value="Hudson Sq">Hudson Sq</option><option value="Kips Bay">Kips Bay</option><option value="Lenox Hill East">Lenox Hill East</option><option value="Lenox Hill West">Lenox Hill West</option><option value="Lincoln Square East">Lincoln Square East</option><option value="Lincoln Square West">Lincoln Square West</option><option value="Little Italy/NoLiTa">Little Italy/NoLiTa</option><option value="Long Island City/Hunters Point">Long Island City/Hunters Point</option><option value="Long Island City/Queens Plaza">Long Island City/Queens Plaza</option><option value="Lower East Side">Lower East Side</option><option value="Manhattan Valley">Manhattan Valley</option><option value="Meatpacking/West Village West">Meatpacking/West Village West</option><option value="Midtown Center">Midtown Center</option><option value="Midtown East" selected="true">Midtown East</option><option value="Midtown North">Midtown North</option><option value="Midtown South">Midtown South</option><option value="Murray Hill">Murray Hill</option><option value="Park Slope">Park Slope</option><option value="Penn Station/Madison Sq West">Penn Station/Madison Sq West</option><option value="Prospect Heights">Prospect Heights</option><option value="Prospect Park">Prospect Park</option><option value="Queensbridge/Ravenswood">Queensbridge/Ravenswood</option><option value="Red Hook">Red Hook</option><option value="Seaport">Seaport</option><option value="SoHo">SoHo</option><option value="South Williamsburg">South Williamsburg</option><option value="Stuy Town/Peter Cooper Village">Stuy Town/Peter Cooper Village</option><option value="Stuyvesant Heights">Stuyvesant Heights</option><option value="Sunnyside">Sunnyside</option><option value="Sunset Park West">Sunset Park West</option><option value="Sutton Place/Turtle Bay North">Sutton Place/Turtle Bay North</option><option value="Times Sq/Theatre District">Times Sq/Theatre District</option><option value="TriBeCa/Civic Center">TriBeCa/Civic Center</option><option value="Two Bridges/Seward Park">Two Bridges/Seward Park</option><option value="UN/Turtle Bay South">UN/Turtle Bay South</option><option value="Union Sq">Union Sq</option><option value="Upper East Side North">Upper East Side North</option><option value="Upper East Side South">Upper East Side South</option><option value="Upper West Side North">Upper West Side North</option><option value="Upper West Side South">Upper West Side South</option><option value="West Chelsea/Hudson Yards">West Chelsea/Hudson Yards</option><option value="West Village">West Village</option><option value="Williamsburg (North Side)">Williamsburg (North Side)</option><option value="Williamsburg (South Side)">Williamsburg (South Side)</option><option value="World Trade Center">World Trade Center</option><option value="Yorkville East">Yorkville East</option><option value="Yorkville West">Yorkville West</option></select></div><div class="vega-bind"><span class="vega-bind-name">time_of_day</span><span class="vega-bind-radio"><input id="vega-option-time_of_day-8:00 AM–11:00 AM" type="radio" name="time_of_day" value="8:00 AM–11:00 AM" checked="true"><label for="vega-option-time_of_day-8:00 AM–11:00 AM">8:00 AM–11:00 AM</label><input id="vega-option-time_of_day-11:00 AM–4:00 PM" type="radio" name="time_of_day" value="11:00 AM–4:00 PM"><label for="vega-option-time_of_day-11:00 AM–4:00 PM">11:00 AM–4:00 PM</label><input id="vega-option-time_of_day-4:00 PM–7:00 PM" type="radio" name="time_of_day" value="4:00 PM–7:00 PM"><label for="vega-option-time_of_day-4:00 PM–7:00 PM">4:00 PM–7:00 PM</label><input id="vega-option-time_of_day-7:00 PM–10:00 PM" type="radio" name="time_of_day" value="7:00 PM–10:00 PM"><label for="vega-option-time_of_day-7:00 PM–10:00 PM">7:00 PM–10:00 PM</label><input id="vega-option-time_of_day-10:00 PM–8:00 AM" type="radio" name="time_of_day" value="10:00 PM–8:00 AM"><label for="vega-option-time_of_day-10:00 PM–8:00 AM">10:00 PM–8:00 AM</label></span></div></div></div>
                            </div>
<script>
$(function() {
  var tooltip_x_handlers = [
    {
      events: "@taxi_zone_marks:mouseover",
      update: "x() - 100 < 10 ? 10 : (x() - 100 > width - 240 ? width - 240 : x() - 100)"
    },
    {
      events: "@taxi_zone_marks:mouseout",
      update: "-999"
    },
    {
      events: "@taxi_zone_marks:click",
      update: "-999"
    }
  ]
  var tooltip_y_handlers = [
    {
      events: "@taxi_zone_marks:mouseover",
      update: "y() - 145 < 15 ? y() + 50 : y() - 145"
    }
  ]

  var selected_location_click_handler = [
    {
      events: "@taxi_zone_marks:click",
      update: "datum.properties.zone"
    },
    {
      events: "@taxi_zone_base_marks:click",
      update: "datum.properties.zone"
    }
  ];

  var map_width = 550;
  var map_height = 540;
  var map_center = [-73.889, 40.75];
  var map_scale = 192000;

  var vega_spec = {
    $schema: "https://vega.github.io/schema/vega/v5.0.json",
    width: map_width,
    height: map_height,
    autosize: "none",
    signals: [
      {
        name: "selected_location",
        bind: {
          input: "select",
          options: ['Alphabet City', 'Battery Park', 'Battery Park City', 'Bedford', 'Bloomingdale', 'Boerum Hill', 'Brooklyn Heights', 'Brooklyn Navy Yard', 'Bushwick South', 'Carroll Gardens', 'Central Park', 'Chinatown', 'Clinton East', 'Clinton Hill', 'Clinton West', 'Cobble Hill', 'Columbia Street', 'Crown Heights North', 'Downtown Brooklyn/MetroTech', 'DUMBO/Vinegar Hill', 'East Chelsea', 'East Harlem South', 'East Village', 'East Williamsburg', 'Financial District North', 'Financial District South', 'Flatiron', 'Fort Greene', 'Garment District', 'Gowanus', 'Gramercy', 'Greenpoint', 'Greenwich Village North', 'Greenwich Village South', 'Hudson Sq', 'Kips Bay', 'Lenox Hill East', 'Lenox Hill West', 'Lincoln Square East', 'Lincoln Square West', 'Little Italy/NoLiTa', 'Long Island City/Hunters Point', 'Long Island City/Queens Plaza', 'Lower East Side', 'Manhattan Valley', 'Meatpacking/West Village West', 'Midtown Center', 'Midtown East', 'Midtown North', 'Midtown South', 'Murray Hill', 'Park Slope', 'Penn Station/Madison Sq West', 'Prospect Heights', 'Prospect Park', 'Queensbridge/Ravenswood', 'Red Hook', 'Seaport', 'SoHo', 'South Williamsburg', 'Stuy Town/Peter Cooper Village', 'Stuyvesant Heights', 'Sunnyside', 'Sunset Park West', 'Sutton Place/Turtle Bay North', 'Times Sq/Theatre District', 'TriBeCa/Civic Center', 'Two Bridges/Seward Park', 'UN/Turtle Bay South', 'Union Sq', 'Upper East Side North', 'Upper East Side South', 'Upper West Side North', 'Upper West Side South', 'West Chelsea/Hudson Yards', 'West Village', 'Williamsburg (North Side)', 'Williamsburg (South Side)', 'World Trade Center', 'Yorkville East', 'Yorkville West']
        },
        value: "Midtown East",
        on: selected_location_click_handler
      },
      {
        name: "time_of_day",
        bind: {
          input: "radio",
          options: ["8:00 AM–11:00 AM", "11:00 AM–4:00 PM", "4:00 PM–7:00 PM", "7:00 PM–10:00 PM", "10:00 PM–8:00 AM"]
        },
        value: "8:00 AM–11:00 AM"
      },
      {
        name: "hover_area",
        value: null,
        on: [
          {
            events: "@taxi_zone_marks:mouseover",
            update: "datum"
          },
          {
            events: "@taxi_zone_marks:mouseout",
            update: "null"
          }
        ]
      },
      {
        name: "tooltip_title",
        value: null,
        update: "hover_area ? selected_location + ' to ' + hover_area.properties.zone : ''"
      },
      {
        name: "tooltip_from",
        value: null,
        update: "hover_area ? 'From ' + selected_location : ''"
      },
      {
        name: "tooltip_to",
        value: null,
        update: "hover_area ? 'to ' + hover_area.properties.zone : ''"
      },
      {
        name: "tooltip_time_of_day",
        value: null,
        update: "hover_area ? 'Weekdays ' + time_of_day : ''"
      },
      {
        name: "tooltip_citi_median",
        value: null,
        update: "hover_area ? 'Citi Bike median: ' + timeFormat(1000 * hover_area.citi_median, '%-M:%S') : ''"
      },
      {
        name: "tooltip_x",
        value: -999,
        on: tooltip_x_handlers
      },
      {
        name: "tooltip_y",
        value: -999,
        on: tooltip_y_handlers
      }
    ],
    data: [
      {
        name: "simulation_results",
        url: "https://cdn.toddwschneider.com/taxi_vs_citibike/simulation_results.csv",
        format: {type: "csv", parse: "auto"},
        transform: [
          {
            type: "filter",
            expr: "datum.time_bucket == time_of_day && datum.start_zone == selected_location"
          }
        ]
      },
      {
        name: "east_river_bridges",
        url: "https://cdn.toddwschneider.com/taxi_vs_citibike/east_river_bridges.json",
        format: {type: "topojson", feature: "bridges"}
      },
      {
        name: "taxi_zones",
        url: "https://cdn.toddwschneider.com/taxi_vs_citibike/taxi_zones_bmq.json",
        format: {type: "topojson", feature: "trimmed_taxi_zones_geojson"},
        transform: [
          {
            type: "lookup",
            from: "simulation_results",
            key: "end_taxi_zone_id",
            fields: ["properties.locationid"],
            values: [ "citi_median"],
            as: [ "citi_median"]
          }
        ]
      },
      {
        name: "taxi_zones_with_data",
        source: "taxi_zones",
      },
      {
        name: "selected_taxi_zone_origin",
        source: "taxi_zones",
        transform: [
          {
            type: "filter",
            expr: "datum.properties.zone == selected_location"
          }
        ]
      }
    ],
    projections: [
      {
        name: "projection",
        type: "mercator",
        center: map_center,
        scale: map_scale
      }
    ],
    scales: [
      {
        name: "color",
        type: "sequential",
        domain: [0.05, 0.95],
        range: {scheme: "yellowgreenblue"}
      }
    ],
    marks: [
      {
        type: "shape",
        name: "taxi_zone_base_marks",
        from: {data: "taxi_zones"},
        encode: {
          update: {
            fill: {value: "#f4f4f4"},
            fillOpacity: {value: 0.5},
            stroke: {value: "#aaa"},
            strokeWidth: {value: 0.2},
            zindex: {value: 0}
          },
        },
        transform: [
          {type: "geoshape", projection: "projection"}
        ]
      },
      {
        type: "shape",
        name: "east_river_bridges_marks",
        from: {data: "east_river_bridges"},
        encode: {
          update: {
            stroke: {value: "#777"},
            strokeWidth: {value: 2}
          }
        },
        transform: [
          {type: "geoshape", projection: "projection"}
        ]
      },
      {
        type: "shape",
        name: "taxi_zone_marks",
        from: {data: "taxi_zones_with_data"},
        encode: {
          update: {
            fill: {
              scale: "color",
              field: "citi_median" 
            },
            fillOpacity: {value: 1},
            stroke: {value: "#777"},
            strokeWidth: {value: 0.2},
            zindex: {value: 10}
          },
          hover: {
            fillOpacity: {value: 0.8},
            stroke: {value: "#222"},
            strokeWidth: {value: 2},
            zindex: {value: 100}
          }
        },
        transform: [
          {type: "geoshape", projection: "projection"}
        ]
      },
      {
        type: "shape",
        name: "selected_taxi_zone_marks",
        from: {data: "selected_taxi_zone_origin"},
        encode: {
          update: {
            fill: {value: "#f00"},
            fillOpacity: {value: 1},
            stroke: {value: "#222"},
            strokeWidth: {value: 2},
            zindex: {value: 1000}
          }
        },
        transform: [
          {type: "geoshape", projection: "projection"}
        ]
      },
      {
        type: "rect",
        interactive: false,
        encode: {
          update: {
            width: {value: 243},
            height: {value: 127},
            fill: {value: "#fff"},
            fillOpacity: {value: 0.9},
            stroke: {value: "#777"},
            strokeWidth: {value: 2},
            cornerRadius: {value: 2},
            x: {signal: "tooltip_x - 5"},
            y: {signal: "tooltip_y - 15"}
          }
        }
      },
      {
        type: "text",
        interactive: false,
        encode: {
          update: {
            x: {signal: "tooltip_x"},
            y: {signal: "tooltip_y"},
            fontSize: {value: 14},
            text: {
              signal: "tooltip_from"
            }
          }
        }
      },
      {
        type: "text",
        interactive: false,
        encode: {
          update: {
            x: {signal: "tooltip_x"},
            y: {signal: "tooltip_y + 16"},
            fontSize: {value: 14},
            text: {
              signal: "tooltip_to"
            }
          }
        }
      },
      {
        type: "text",
        interactive: false,
        encode: {
          update: {
            x: {signal: "tooltip_x"},
            y: {signal: "tooltip_y + 40"},
            fontSize: {value: 14},
            text: {
              signal: "tooltip_time_of_day"
            }
          }
        }
      },
      {
        type: "text",
        interactive: false,
        encode: {
          update: {
            x: {signal: "tooltip_x"},
            y: {signal: "tooltip_y + 82"},
            fontSize: {value: 14},
            text: {
              signal: "tooltip_citi_median"
            }
          }
        }
      },
      {
        type: "text",
        description: "hack to get the legend labels to work",
        interactive: false,
        encode: {
          update: {
            x: {value: map_width - 168},
            y: {value: map_height - 15},
            text: {value: "0%" + vega.repeat(" ", 39) + "100%"}
          }
        }
      }
    ]
  };

  var vega_opts = {
    loader: vega.loader(),
    logLevel: vega.Warn,
    renderer: 'canvas'
  };

  var view = new vega.View(vega.parse(vega_spec), vega_opts).
    initialize('#nyc-taxi-zones-map').
    hover().
    run();

  $("#nyc-taxi-vs-citi-select-container").show();

  $("#nyc-taxi-vs-citi-select").on("change", function() {
    view.signal("selected_location", $(this).val()).run();
    set_title();
  });

  $("input[name='nyc-taxi-vs-citi-time']").on("change", function() {
    view.signal("time_of_day", $(this).val()).run();
    set_title();
  });

  $(".williamsburg-link").on("click", function() {
    $("#nyc-taxi-vs-citi-select").val("Williamsburg (North Side)");
    view.signal("selected_location", "Williamsburg (North Side)").run();
    set_title();
  });

  var $title = $(".taxi-vs-citi-map-title");

  var set_title = function() {
    var new_title = "From " + $("#nyc-taxi-vs-citi-select").val() + ", weekdays " + $("input[name='nyc-taxi-vs-citi-time']:checked").val();
    $title.html(new_title);
  };

  $("#nyc-taxi-zones-map").on("click", function() {
    vega_val = $("select[name='selected_location']").val();
    outer_select = $("#nyc-taxi-vs-citi-select");
    outer_val = outer_select.val();

    if (vega_val !== outer_val) {
      outer_select.val(vega_val);
      set_title();
    }
  });

});
</script>

</div>
